<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¢çš„ç–ŠåŠ åŸç†äº’å‹•æ¨¡æ“¬å™¨ - æ•¸æ“šè¿½è¹¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; overflow-x: hidden; }
        canvas { width: 100%; height: 420px; background: #1e293b; border-radius: 1rem; border: 1px solid #334155; }
        .control-panel { background: #1e293b; padding: 1rem; border-radius: 1rem; border: 1px solid #334155; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #3b82f6; }
        .btn-active { background-color: #3b82f6 !important; color: white; border: 1px solid rgba(255,255,255,0.3); }
        label { font-size: 0.7rem; color: #94a3b8; margin-bottom: 0.15rem; display: block; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <header class="mb-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">ç¹©æ³¢ç–ŠåŠ å¯¦é©—å®¤</h1>
            <div class="flex gap-2">
                <button id="modePulse" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-bold transition btn-active text-xs">è‡ªå‹•ç›¸æ’æ¨¡å¼</button>
                <button id="modeFree" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-bold transition text-xs">è‡ªç”±å¯¦é©—æ¨¡å¼</button>
            </div>
        </header>

        <!-- ç•«å¸ƒå€åŸŸ -->
        <div class="relative mb-4">
            <canvas id="superCanvas"></canvas>
            <div class="absolute top-4 left-4 flex flex-row gap-6 bg-black/40 p-2 rounded-lg backdrop-blur-sm text-[10px] border border-white/10">
                <div class="flex items-center gap-2"><div class="w-5 h-1 bg-green-400 shadow-[0_0_5px_#4ade80]"></div> ç¹©æ³¢ A</div>
                <div class="flex items-center gap-2"><div class="w-5 h-1 bg-red-400 shadow-[0_0_5px_#f87171]"></div> ç¹©æ³¢ B</div>
                <div class="flex items-center gap-2"><div class="w-5 h-1 bg-blue-400 border border-white/50 shadow-[0_0_5px_#60a5fa]"></div> åˆæˆæ³¢ (A+B)</div>
            </div>
        </div>

        <!-- æ“æ§å€åŸŸ -->
        <div class="control-panel">
            <!-- è„ˆè¡æ¨¡å¼æ§åˆ¶ (è‡ªå‹•ç›¸æ’) -->
            <div id="pulseControls" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-center">
                <div class="flex flex-col gap-1">
                    <label>ç›¸æ’æ–¹å¼</label>
                    <div class="flex gap-1">
                        <button id="pulseConstructive" class="flex-1 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-[10px] transition">éƒ½åœ¨ä¸Šæ–¹</button>
                        <button id="pulseDestructive" class="flex-1 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-[10px] btn-active transition">ä¸€ä¸Šä¸€ä¸‹</button>
                    </div>
                </div>
                <div class="flex flex-col gap-1">
                    <label>æ“ä½œæ§åˆ¶</label>
                    <div class="flex gap-1">
                        <button id="pulsePlay" class="flex-[1.5] py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded font-bold text-xs shadow-lg">ğŸš€ ç™¼å°„</button>
                        <button id="pauseBtn" class="flex-1 py-1.5 bg-amber-600 hover:bg-amber-500 rounded font-bold text-xs shadow-lg transition">â¸ æš«åœ</button>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label>ç§»å‹•é€Ÿåº¦</label>
                    <input type="range" id="speedRange" min="0.1" max="1.5" value="0.5" step="0.1">
                </div>
            </div>

            <!-- è‡ªç”±æ¨¡å¼æ§åˆ¶ (æ‰‹å‹•èª¿æ•´å…©æ®µè„ˆè¡æ³¢) -->
            <div id="freeControls" class="hidden grid grid-cols-1 md:grid-cols-2 gap-10">
                <!-- ç¹©æ³¢ A æ§åˆ¶ -->
                <div class="grid grid-cols-3 gap-4 p-2 bg-green-900/10 rounded-lg border border-green-500/20 items-center">
                    <div class="col-span-3 mb-1 flex justify-between items-center">
                        <h4 class="text-green-400 text-[10px] font-bold uppercase tracking-wider">ç¹©æ³¢ A (ç¶ )</h4>
                        <span class="text-[10px] text-slate-500 italic">èª¿æ•´æ»‘æ¡¿è§€å¯Ÿè®Šå½¢</span>
                    </div>
                    <div>
                        <label>é«˜çŸ® (æŒ¯å¹…): <span id="ampALabel" class="text-white">1.0</span></label>
                        <input type="range" id="ampARange" min="-1.5" max="1.5" value="1.0" step="0.1">
                    </div>
                    <div>
                        <label>å¯¬çª„ (å¯¬åº¦): <span id="widthALabel" class="text-white">80</span></label>
                        <input type="range" id="widthARange" min="30" max="200" value="80" step="5">
                    </div>
                    <div>
                        <label>å·¦å³ä½ç½®</label>
                        <input type="range" id="posARange" min="0" max="100" value="35" step="0.5">
                    </div>
                </div>

                <!-- ç¹©æ³¢ B æ§åˆ¶ -->
                <div class="grid grid-cols-3 gap-4 p-2 bg-red-900/10 rounded-lg border border-red-500/20 items-center">
                    <div class="col-span-3 mb-1 flex justify-between items-center">
                        <h4 class="text-red-400 text-[10px] font-bold uppercase tracking-wider">ç¹©æ³¢ B (ç´…)</h4>
                        <span class="text-[10px] text-slate-500 italic">å·¦å³æŒªå‹•å°é½Š A æ³¢</span>
                    </div>
                    <div>
                        <label>é«˜çŸ® (æŒ¯å¹…): <span id="ampBLabel" class="text-white">-1.0</span></label>
                        <input type="range" id="ampBRange" min="-1.5" max="1.5" value="-1.0" step="0.1">
                    </div>
                    <div>
                        <label>å¯¬çª„ (å¯¬åº¦): <span id="widthBLabel" class="text-white">80</span></label>
                        <input type="range" id="widthBRange" min="30" max="200" value="80" step="5">
                    </div>
                    <div>
                        <label>å·¦å³ä½ç½®</label>
                        <input type="range" id="posBRange" min="0" max="100" value="65" step="0.5">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. Interaction Logger (æ•¸æ“šè¿½è¹¤å·¥å…·)
        // ==========================================
        const STORAGE_KEY = "TaskInteractionData";
        let interactionHistory = [];

        const InteractionLogger = {
            init: function() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed)) {
                            interactionHistory = parsed;
                        }
                    } catch (e) {
                        console.warn("Failed to parse existing interaction data", e);
                        interactionHistory = [];
                    }
                }
                // Log initialization
                this.log('Initialize', { timestamp: new Date().toISOString() });
            },

            log: function(action, details = {}) {
                const event = {
                    timestamp: new Date().toISOString(),
                    action: action,
                    details: details
                };
                interactionHistory.push(event);
                // é™åˆ¶æ­·å²ç´€éŒ„é•·åº¦ï¼Œé¿å… localStorage çˆ†æ»¿ (é¸ç”¨ï¼Œç›®å‰è¨­ç‚º 500 ç­†)
                if (interactionHistory.length > 500) {
                    interactionHistory.shift();
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(interactionHistory));
                // Console log for debugging
                // console.log(`[Logged]: ${action}`, details); 
            },

            clear: function() {
                interactionHistory = [];
                localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
            }
        };

        // åˆå§‹åŒ– Logger
        InteractionLogger.init();


        // ==========================================
        // 2. æ¨¡æ“¬å™¨æ ¸å¿ƒé‚è¼¯
        // ==========================================
        const canvas = document.getElementById('superCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            width = canvas.clientWidth;
            height = canvas.clientHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        let mode = 'pulse'; 
        let isPulsing = false;
        let isPaused = false;
        let pulseTime = 0;
        let pulseType = 'destructive'; 
        let simulationSpeed = 0.5;

        // è‡ªç”±æ¨¡å¼åƒæ•¸
        let freeParams = {
            ampA: 1.0, widthA: 80, posA: 35,
            ampB: -1.0, widthB: 80, posB: 65
        };

        function getPulseY(x, centerX, widthScale, amplitude) {
            const dist = x - centerX;
            if (Math.abs(dist) > widthScale) return 0;
            const k = Math.PI / widthScale;
            let val = Math.sin(k * (dist + widthScale) / 2) * Math.sin(Math.PI * (dist + widthScale) / widthScale);
            return val * amplitude * 100;
        }

        function draw() {
            if (!isPaused && mode === 'pulse' && isPulsing) {
                pulseTime += simulationSpeed;
                if (pulseTime * 5 > width + 400) {
                    isPulsing = false;
                    pulseTime = 0;
                    // Log simulation finished
                    InteractionLogger.log('SimulationCompleted', { mode: 'pulse' });
                }
            }

            ctx.clearRect(0, 0, width, height);
            const centerY = height / 2;
            const waveAY = new Array(Math.floor(width)).fill(0);
            const waveBY = new Array(Math.floor(width)).fill(0);

            if (mode === 'pulse') {
                const centerA = pulseTime * 5 - 100;
                const centerB = width - (pulseTime * 5) + 100;
                
                for (let x = 0; x < width; x++) {
                    waveAY[x] = getPulseY(x, centerA, 80, 1.0);
                    waveBY[x] = getPulseY(x, centerB, 80, pulseType === 'destructive' ? -1.0 : 1.0);
                }
            } else {
                const centerA = (freeParams.posA / 100) * width;
                const centerB = (freeParams.posB / 100) * width;
                
                for (let x = 0; x < width; x++) {
                    waveAY[x] = getPulseY(x, centerA, freeParams.widthA, freeParams.ampA);
                    waveBY[x] = getPulseY(x, centerB, freeParams.widthB, freeParams.ampB);
                }
            }

            // ç¹ªè£½ A (ç¶ )
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.strokeStyle = '#4ade80';
            ctx.globalAlpha = 0.5;
            for (let x = 0; x < width; x++) {
                if (x === 0) ctx.moveTo(x, centerY + waveAY[x]); else ctx.lineTo(x, centerY + waveAY[x]);
            }
            ctx.stroke();

            // ç¹ªè£½ B (ç´…)
            ctx.beginPath();
            ctx.strokeStyle = '#f87171';
            for (let x = 0; x < width; x++) {
                if (x === 0) ctx.moveTo(x, centerY + waveBY[x]); else ctx.lineTo(x, centerY + waveBY[x]);
            }
            ctx.stroke();

            // ç¹ªè£½åˆæˆ (è—)
            ctx.beginPath();
            ctx.strokeStyle = '#60a5fa';
            ctx.globalAlpha = 1;
            ctx.lineWidth = 6;
            for (let x = 0; x < width; x++) {
                const sumY = waveAY[x] + waveBY[x];
                if (x === 0) ctx.moveTo(x, centerY + sumY); else ctx.lineTo(x, centerY + sumY);
            }
            ctx.stroke();

            // åŸºæº–ç·š
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = '#475569';
            ctx.lineWidth = 1;
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            ctx.setLineDash([]);

            requestAnimationFrame(draw);
        }

        // ==========================================
        // 3. äº‹ä»¶ç¶å®š & æ•¸æ“šåŸ‹é» (Logging)
        // ==========================================

        document.getElementById('pauseBtn').addEventListener('click', function() {
            isPaused = !isPaused;
            this.innerText = isPaused ? "â–¶ ç¹¼çºŒ" : "â¸ æš«åœ";
            this.classList.toggle('bg-amber-600', !isPaused);
            this.classList.toggle('bg-emerald-600', isPaused);
            
            // Log Event
            InteractionLogger.log('TogglePause', { isPaused: isPaused });
        });

        document.getElementById('modePulse').addEventListener('click', function() {
            mode = 'pulse';
            this.classList.add('btn-active');
            document.getElementById('modeFree').classList.remove('btn-active');
            document.getElementById('pulseControls').classList.remove('hidden');
            document.getElementById('freeControls').classList.add('hidden');
            isPulsing = false;

            // Log Event
            InteractionLogger.log('SwitchMode', { mode: 'pulse' });
        });

        document.getElementById('modeFree').addEventListener('click', function() {
            mode = 'free';
            isPaused = false; // è‡ªç”±æ¨¡å¼ä¸è¨­æš«åœ
            this.classList.add('btn-active');
            document.getElementById('modePulse').classList.remove('btn-active');
            document.getElementById('pulseControls').classList.add('hidden');
            document.getElementById('freeControls').classList.remove('hidden');

            // Log Event
            InteractionLogger.log('SwitchMode', { mode: 'free' });
        });

        document.getElementById('pulsePlay').addEventListener('click', () => {
            pulseTime = 0; isPulsing = true; isPaused = false;
            const pb = document.getElementById('pauseBtn');
            pb.innerText = "â¸ æš«åœ";
            pb.classList.add('bg-amber-600');
            pb.classList.remove('bg-emerald-600');

            // Log Event
            InteractionLogger.log('RunPulseSimulation', { 
                type: pulseType, 
                speed: simulationSpeed 
            });
        });

        document.getElementById('pulseConstructive').addEventListener('click', function() {
            pulseType = 'constructive';
            this.classList.add('btn-active');
            document.getElementById('pulseDestructive').classList.remove('btn-active');

            // Log Event
            InteractionLogger.log('SetCollisionType', { type: 'constructive' });
        });

        document.getElementById('pulseDestructive').addEventListener('click', function() {
            pulseType = 'destructive';
            this.classList.add('btn-active');
            document.getElementById('pulseConstructive').classList.remove('btn-active');

            // Log Event
            InteractionLogger.log('SetCollisionType', { type: 'destructive' });
        });

        const bindRange = (id, labelId, key) => {
            const el = document.getElementById(id);
            if (!el) return;
            
            // 'input' äº‹ä»¶ï¼šç”¨æ–¼å³æ™‚ UI æ›´æ–° (ç¶­æŒåŸæœ¬æµæš¢åº¦)
            el.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                freeParams[key] = val;
                if (labelId) {
                    const label = document.getElementById(labelId);
                    if (label) label.innerText = val;
                }
            });

            // 'change' äº‹ä»¶ï¼šç”¨æ–¼ Log ç´€éŒ„ (é¿å…æ‹–æ›³æ™‚ç”¢ç”Ÿéå¤šåƒåœ¾æ•¸æ“š)
            el.addEventListener('change', (e) => {
                InteractionLogger.log('UpdateWaveParam', { 
                    parameter: key, 
                    value: parseFloat(e.target.value) 
                });
            });
        };

        bindRange('ampARange', 'ampALabel', 'ampA');
        bindRange('widthARange', 'widthALabel', 'widthA');
        bindRange('posARange', null, 'posA');
        bindRange('ampBRange', 'ampBLabel', 'ampB');
        bindRange('widthBRange', 'widthBLabel', 'widthB');
        bindRange('posBRange', null, 'posB');

        const speedEl = document.getElementById('speedRange');
        
        // é€Ÿåº¦æ»‘æ¡¿çš„å³æ™‚æ›´æ–°
        speedEl.addEventListener('input', (e) => {
            simulationSpeed = parseFloat(e.target.value);
        });
        
        // é€Ÿåº¦æ»‘æ¡¿çš„ Log
        speedEl.addEventListener('change', (e) => {
            InteractionLogger.log('ChangeSpeed', { value: parseFloat(e.target.value) });
        });

        draw();
    </script>
</body>
</html>
