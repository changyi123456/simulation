<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANC é™å™ªè€³æ©Ÿæƒ…å¢ƒæ¨¡æ“¬å™¨ - æ•¸æ“šè¿½è¹¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: sans-serif; }
        canvas { width: 100%; height: 450px; background: #0f172a; border-radius: 1rem; border: 1px solid #1e293b; }
        .control-panel { background: #1e293b; padding: 1.5rem; border-radius: 1rem; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #3b82f6; }
        .temp-display { font-family: 'Courier New', Courier, monospace; }
        .efficiency-bar { height: 8px; border-radius: 4px; background: #334155; overflow: hidden; }
        .efficiency-fill { height: 100%; transition: width 0.3s; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white">ä¸»å‹•é™å™ªï¼šç‚ºä»€éº¼è²éŸ³ä¸è¦‹äº†ï¼Ÿ</h1>
                <p class="text-slate-400 mt-1">äº’å‹•é‡é»ï¼šè©¦è‘—ç§»å‹•ã€Œæ³¢å½¢ä½ç½®ã€ï¼Œæ‰¾å‡ºèƒ½è®Šå®‰éœçš„ç¥ç§˜è§’åº¦</p>
            </div>
            <div class="flex gap-4">
                <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <span class="text-xs text-slate-400 block uppercase font-bold">ç›®å‰è€³æ©Ÿæº«åº¦</span>
                    <span id="tempVal" class="text-xl font-bold text-orange-400 temp-display">25.00</span> <span class="text-orange-400 text-sm">Â°C</span>
                </div>
                <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 min-w-[140px]">
                    <span class="text-xs text-slate-400 block uppercase font-bold">å®‰éœç¨‹åº¦ (æŠµæ¶ˆç‡)</span>
                    <div class="efficiency-bar mt-2">
                        <div id="effFill" class="efficiency-fill bg-emerald-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦è¦–è¦ºå€åŸŸ -->
        <div class="relative mb-6">
            <canvas id="ancCanvas"></canvas>
            <div class="absolute bottom-4 left-4 flex flex-wrap gap-4 bg-black/60 p-3 rounded-lg backdrop-blur-md text-xs border border-white/10">
                <div class="flex items-center gap-2"><div class="w-8 h-1 bg-green-400 shadow-[0_0_8px_#4ade80]"></div> ç’°å¢ƒå™ªéŸ³ (åŸæœ¬çš„è²éŸ³)</div>
                <div class="flex items-center gap-2"><div class="w-8 h-1 bg-red-400 shadow-[0_0_8px_#f87171]"></div> è€³æ©Ÿç™¼å‡ºçš„è²éŸ³</div>
                <div class="flex items-center gap-2"><div class="w-8 h-1 bg-blue-400 shadow-[0_0_8px_#60a5fa]"></div> æœ€å¾Œé€²å…¥è€³æœµçš„è²éŸ³</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- åƒæ•¸æ§åˆ¶ -->
            <div class="control-panel shadow-2xl space-y-6">
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="font-medium">å™ªéŸ³çš„é«˜ä½éŸ³ (é »ç‡)</label>
                    </div>
                    <input type="range" id="freqRange" min="50" max="400" value="120" step="1">
                    <p class="text-xs text-slate-500 mt-1">ä½æ²‰è¦å¾‹çš„è²éŸ³ï¼ˆå¦‚å¼•æ“ï¼‰æœ€å®¹æ˜“é™å™ª</p>
                </div>

                <div>
                    <label class="font-medium block mb-2">ç§»å‹•è€³æ©Ÿè²æ³¢çš„ä½ç½® (å·¦å³å°é½Š)</label>
                    <input type="range" id="phaseRange" min="0" max="360" value="0" step="1">
                    <div class="flex justify-between text-[10px] text-slate-400 mt-1">
                        <span>åŒæ­¥èµ°</span>
                        <span>å°é½Šä¸€åŠ</span>
                        <span>å®Œå…¨ç›¸å</span>
                        <span>ç¹å›åŸé»</span>
                    </div>
                    <button id="autoANC" class="w-full mt-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-sm font-bold transition shadow-lg">
                        è‡ªå‹•å°‹æ‰¾ã€Œå®Œå…¨ç›¸åã€çš„ä½ç½®
                    </button>
                </div>
            </div>

            <!-- éŸ³æ•ˆèˆ‡éŸ³é‡ -->
            <div class="control-panel shadow-2xl flex flex-col justify-center gap-6">
                <div>
                    <label class="font-medium block mb-2">å™ªéŸ³å¤§å°è²</label>
                    <input type="range" id="volRange" min="0" max="0.6" value="0.3" step="0.01">
                </div>
                <button id="audioBtn" class="py-4 bg-emerald-600 hover:bg-emerald-700 rounded-xl font-bold text-lg transition flex items-center justify-center gap-2 shadow-lg">
                    ğŸ”ˆ é–‹å•Ÿæ¨¡æ“¬å™ªéŸ³
                </button>
            </div>

            <!-- æ•™å­¸å¼•å° -->
            <div class="control-panel bg-slate-800/50 border border-slate-700 flex flex-col justify-between">
                <div>
                    <h3 class="font-bold text-slate-200 mb-2 border-b border-slate-700 pb-1">èª²å ‚æ€è€ƒé¡Œ</h3>
                    <p id="statusMsg" class="text-sm text-slate-400 italic">è©¦è©¦çœ‹ï¼šæ³¢å½¢æŒªç§»åˆ°ä»€éº¼ä½ç½®ï¼Œè²éŸ³æœƒè®Šæœ€å°ï¼Ÿ</p>
                </div>
                <div class="bg-black/40 p-3 rounded-md border border-white/5">
                    <h4 class="text-[10px] text-orange-400 uppercase font-bold tracking-widest mb-1 italic">è§€å¯Ÿé‡é»</h4>
                    <p class="text-xs text-slate-300 leading-relaxed">
                        1. ç•¶è—è‰²è²æ³¢å¹¾ä¹æ¶ˆå¤±æ™‚ï¼Œçœ‹å³ä¸Šæ–¹çš„æº«åº¦è¨ˆã€‚<br>
                        2. æ€è€ƒï¼šæ¶ˆå¤±çš„è²éŸ³èƒ½é‡ï¼Œè®Šæˆäº†ä»€éº¼ï¼Ÿ
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. Interaction Logger (æ•¸æ“šè¿½è¹¤å·¥å…·)
        // ==========================================
        const STORAGE_KEY = "TaskInteractionData";
        let interactionHistory = [];

        const InteractionLogger = {
            init: function() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed)) {
                            interactionHistory = parsed;
                        }
                    } catch (e) {
                        console.warn("Failed to parse existing interaction data", e);
                        interactionHistory = [];
                    }
                }
                this.log('Initialize', { timestamp: new Date().toISOString(), sim: "ANC_Simulation" });
            },

            log: function(action, details = {}) {
                const event = {
                    timestamp: new Date().toISOString(),
                    action: action,
                    details: details
                };
                interactionHistory.push(event);
                if (interactionHistory.length > 500) {
                    interactionHistory.shift();
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(interactionHistory));
                // console.log(`[Logged]: ${action}`, details); 
            },

            clear: function() {
                interactionHistory = [];
                localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
            }
        };

        // åˆå§‹åŒ– Logger
        InteractionLogger.init();


        // ==========================================
        // 2. æ¨¡æ“¬å™¨æ ¸å¿ƒé‚è¼¯
        // ==========================================
        const canvas = document.getElementById('ancCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        let state = {
            phase: 0,
            freq: 120,
            volume: 0.3,
            time: 0,
            baseTemp: 25.0,
            currentTemp: 25.0,
            efficiency: 0,
            isAudioOn: false
        };

        function resize() {
            width = canvas.clientWidth;
            height = canvas.clientHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        let audioCtx, oscNoise, oscAnti, gainMaster;

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            oscNoise = audioCtx.createOscillator();
            oscAnti = audioCtx.createOscillator();
            gainMaster = audioCtx.createGain();

            oscNoise.type = 'sine';
            oscAnti.type = 'sine';
            
            oscNoise.connect(gainMaster);
            oscAnti.connect(gainMaster);
            gainMaster.connect(audioCtx.destination);
            
            oscNoise.start();
            oscAnti.start();
            updateAudioParams();
        }

        function updateAudioParams() {
            if (!audioCtx) return;
            oscNoise.frequency.setTargetAtTime(state.freq, audioCtx.currentTime, 0.05);
            oscAnti.frequency.setTargetAtTime(state.freq, audioCtx.currentTime, 0.05);

            const rad = (state.phase * Math.PI) / 180;
            const cancellationFactor = Math.abs(2 * Math.cos(rad / 2)) / 2;
            gainMaster.gain.setTargetAtTime(state.volume * cancellationFactor, audioCtx.currentTime, 0.05);
            
            state.efficiency = (1 - (cancellationFactor)) * 100;
        }

        function drawScene() {
            ctx.clearRect(0, 0, width, height);
            
            const centerY = height / 2;
            const earX = width * 0.7; 
            const headphoneX = width * 0.45; 
            
            ctx.fillStyle = "rgba(255,255,255,0.1)";
            ctx.font = "bold 14px sans-serif";
            ctx.fillText("å¤–éƒ¨ç’°å¢ƒ", 20, 40);

            // 1. ç¹ªè£½è€³æœµ
            ctx.fillStyle = "#1e293b";
            ctx.beginPath();
            ctx.ellipse(earX + 80, centerY, 80, 140, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillRect(earX, centerY - 40, 120, 80);
            ctx.fillStyle = "#f1f5f9";
            ctx.fillText("äººè€³ (å…§éƒ¨è€³é“)", earX + 10, centerY + 70);

            // 2. ç¹ªè£½è€³æ©Ÿ
            ctx.fillStyle = "#334155";
            ctx.beginPath();
            ctx.roundRect(headphoneX - 30, centerY - 100, 60, 200, 15);
            ctx.fill();
            
            // 3. ç™¼ç†±è¦–è¦º
            const heatAlpha = (state.efficiency / 100) * 0.7;
            ctx.fillStyle = `rgba(249, 115, 22, ${heatAlpha})`;
            ctx.shadowBlur = state.efficiency / 5;
            ctx.shadowColor = "rgba(249, 115, 22, 0.8)";
            ctx.beginPath();
            ctx.arc(headphoneX, centerY, 35, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            if (state.efficiency > 30 && state.isAudioOn) {
                ctx.fillStyle = `rgba(251, 146, 60, ${Math.min(1, heatAlpha * 2)})`;
                ctx.font = "bold 18px sans-serif";
                ctx.fillText("âš¡ è€³æ©Ÿæº«åº¦å‡é«˜", headphoneX + 45, centerY - 15);
                
                ctx.beginPath();
                ctx.strokeStyle = `rgba(251, 146, 60, ${Math.min(1, heatAlpha * 2)})`;
                ctx.lineWidth = 2;
                ctx.moveTo(headphoneX + 40, centerY - 10);
                ctx.lineTo(headphoneX + 20, centerY + 5);
                ctx.stroke();
            }

            ctx.fillStyle = "#f1f5f9";
            ctx.font = "bold 14px sans-serif";
            ctx.fillText("é™å™ªè€³æ©Ÿ", headphoneX - 25, centerY + 130);

            // --- æ³¢å½¢ ---
            const amp = 50 * state.volume;
            const pxPerCycle = 1200 / state.freq;
            const phaseRad = (state.phase * Math.PI) / 180;

            ctx.lineWidth = 2;
            ctx.strokeStyle = '#4ade80';
            ctx.globalAlpha = 0.5;
            ctx.beginPath();
            for (let x = 0; x < earX; x++) {
                const y = centerY + Math.sin(x / pxPerCycle - state.time) * amp;
                if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();

            ctx.strokeStyle = '#f87171';
            ctx.beginPath();
            for (let x = headphoneX; x < earX; x++) {
                const y = centerY + Math.sin(x / pxPerCycle - state.time + phaseRad) * amp;
                if (x === headphoneX) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();

            ctx.globalAlpha = 1;
            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 4;
            ctx.beginPath();
            for (let x = headphoneX; x < width; x++) {
                const noiseY = Math.sin(x / pxPerCycle - state.time) * amp;
                const antiY = Math.sin(x / pxPerCycle - state.time + phaseRad) * amp;
                const y = centerY + (noiseY + antiY);
                if (x === headphoneX) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            ctx.strokeStyle = "#94a3b8";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(earX + 110, centerY - 30);
            ctx.lineTo(earX + 110, centerY + 30);
            ctx.stroke();
            ctx.fillStyle = "#94a3b8";
            ctx.font = "10px sans-serif";
            ctx.fillText("è€³è†œ", earX + 105, centerY - 40);

            state.time += 0.12;
            
            if (state.isAudioOn) {
                const targetTemp = state.baseTemp + (state.efficiency / 100) * 3.5 * state.volume;
                state.currentTemp += (targetTemp - state.currentTemp) * 0.005;
            } else {
                state.currentTemp += (state.baseTemp - state.currentTemp) * 0.01;
            }

            document.getElementById('tempVal').innerText = state.currentTemp.toFixed(2);
            document.getElementById('effFill').style.width = state.efficiency + '%';
            
            requestAnimationFrame(drawScene);
        }

        // ==========================================
        // 3. äº‹ä»¶ç¶å®š & æ•¸æ“šåŸ‹é» (Logging)
        // ==========================================

        const freqEl = document.getElementById('freqRange');
        freqEl.addEventListener('input', (e) => {
            state.freq = parseInt(e.target.value);
            updateAudioParams();
        });
        // åŸ‹é»: é »ç‡æ”¹è®Š
        freqEl.addEventListener('change', (e) => {
            InteractionLogger.log('ChangeFrequency', { value: parseInt(e.target.value) });
        });


        const phaseEl = document.getElementById('phaseRange');
        phaseEl.addEventListener('input', (e) => {
            state.phase = parseInt(e.target.value);
            updateAudioParams();
        });
        // åŸ‹é»: ç›¸ä½æ”¹è®Š (é‡è¦ï¼šåŒ…å«æ•ˆç‡ï¼Œè®“ AI çŸ¥é“å­¸ç”Ÿèª¿å¾—å¥½ä¸å¥½)
        phaseEl.addEventListener('change', (e) => {
            InteractionLogger.log('ChangePhase', { 
                value: parseInt(e.target.value),
                current_efficiency: state.efficiency.toFixed(1)
            });
        });


        const volEl = document.getElementById('volRange');
        volEl.addEventListener('input', (e) => {
            state.volume = parseFloat(e.target.value);
            updateAudioParams();
        });
        // åŸ‹é»: éŸ³é‡æ”¹è®Š
        volEl.addEventListener('change', (e) => {
            InteractionLogger.log('ChangeVolume', { value: parseFloat(e.target.value) });
        });


        document.getElementById('autoANC').addEventListener('click', () => {
            state.phase = 180;
            document.getElementById('phaseRange').value = 180;
            updateAudioParams();
            
            // åŸ‹é»: ä½¿ç”¨è‡ªå‹•æ ¡æ­£
            InteractionLogger.log('AutoCalibrate', { target_phase: 180 });
        });

        document.getElementById('audioBtn').addEventListener('click', function() {
            if (!state.isAudioOn) {
                initAudio();
                state.isAudioOn = true;
                this.innerHTML = `<span>ğŸ›‘ é—œé–‰å™ªéŸ³</span>`;
                this.classList.replace('bg-emerald-600', 'bg-red-600');
                
                // åŸ‹é»: é–‹å•Ÿ
                InteractionLogger.log('ToggleSimulation', { status: 'On' });
            } else {
                audioCtx.close();
                state.isAudioOn = false;
                this.innerHTML = `ğŸ”ˆ é–‹å•Ÿæ¨¡æ“¬å™ªéŸ³`;
                this.classList.replace('bg-red-600', 'bg-emerald-600');

                // åŸ‹é»: é—œé–‰
                InteractionLogger.log('ToggleSimulation', { status: 'Off' });
            }
        });

        drawScene();
    </script>
</body>
</html>
